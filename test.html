<!DOCTYPE html>
<meta charset="utf-8">
<html>
<head>

<style>

html {
  overflow: hidden;
  font-family: sans-serif;
}

html, body {
  margin: 0;
  padding: 0;
  height: 100%;
}

body {
  background-color: #999999;
  transition: background-color 1s;
}

body.flip {
  background-color: #ffffff;
}

/* ------------------------------------------------------------------- MAIN SECTIONS LAYOUT */

body {
  perspective: 3000px;
  perspective-origin: 50vw 50vh;

  /* central perspective */
  transform-origin: 50vw 50vh;
  transform-style: preserve-3d;
  transform: scale(0.6);
}

main {
  position: relative;
  height: 100vmin;
  width: 100vmin;
  top: calc(50vh - 50vmin);
  left: calc(50vw - 50vmin);
  transform-origin: 50vmin 50vmin;
  transform-style: preserve-3d;
  transform: translate3d(0,0,0) scale(1) rotateX(0deg) rotateY(-90deg);
  transition: transform 0.7s;
}

.flip main {
  transform: translate3d(0,0,0) scale(1) rotateX(0deg) rotateY(0deg);
}

section {
  position: absolute;
  visibility: hidden;
  top: 0;
  left: 0;

  /* use viewport-relative units to scale sections */
  width: 100vmin;
  height: 100vmin;
  transform-origin: 50% 50%;
  transform-style: preserve-3d;
  backface-visibility: visible;
  border: 4px dashed #666666;
  background-color: rgba(0,0,0,0.02);

  /* delay display:none when flip is removed */
  transition: opacity 0.7s 0s, visibility 0s 0.7s;
  opacity: 0;
  /* cursor: pointer; */
  overflow: hidden;
}
section:hover {
  background-color: rgba(0,0,0,0.06);
}

.flip section {
  visibility: visible;
  opacity: 1;
  transition: opacity 0.7s 0s;
}

.flip section.empty {
  opacity: 0.1;
}

section h2 {
  position: absolute;
  top: 0px;
  left: 10px;
  margin: 0;
  padding: 0;
  font-size: 100px;
  font-weight: bold;
  text-transform: uppercase;
  color: #333333;
}

section.bottom h2 {
  top: auto;
  bottom: 10px;
}

section.right h2 {
  left: auto;
  right: 10px;
}

section#map {
  position: absolute;
  visibility: visible;

  right: 0px;

  z-index: 1;

  overflow: visible;

  background-color: transparent;

  opacity: 1;

  transform: translate(55vmin,0) rotateY(90deg);

}

section#interface {
  position: absolute;
  visibility: visible;
  right: 0px;
  z-index: 1;
  overflow: visible;
  background-color: transparent;
  opacity: 1;
  width: 140vmin;
  height: 140vmin;
  transform: translate(35vmin,-20vmin) rotateY(90deg);
  /* background-color: rgba(0,0,0,0.1); */
  border: 1px solid rgba(0,0,0,0.5);
  pointer-events: none;
}

section#graph {
  border: none;
  background-color: transparent;
  /* SVG's getScreenCTM does not support 3d transforms, so the graph container must not use them */
  /* transform: translate3d(0,0,50vmin) rotateY(0deg); */
  overflow: visible;
  top: -20vmin;
  left: -20vmin;
  width: 140vmin;
  height: 140vmin;
}

section#code {
  transform: translate(0px,0px) translate3d(0,0,-60vmin);
}

section#data {
  transform: translate(-55vmin,0) rotateY(90deg);
}

section#interaction,
section#parameters,
section#author,
section#goals,
section#ecosystem {
  height: 100vmin;
  top: 0;
}


section#interaction {
  transform: translate(0,-55vmin) rotateX(-90deg);
}

section#parameters {
  transform: translate(0,55vmin) rotateX(90deg);
}

/* ------------------------------------------------------------------- OUTER SECTIONS */


section#author {
  width: 110vmin;
  transform: translate(-10vmin,calc(65vmin + calc(30vh - 30vmin))) rotateX(90deg);
}

section#ecosystem {
  width: 130vmin;
  transform: translate(-20vmin,75vmin) rotateX(90deg);
}

section#infrastructure {
  height: 110vmin;
  transform: translate(calc(-65vmin - calc(30vw - 30vmin)), 0) rotateY(90deg);
}


section#perception {
  height: 110vmin;
  transform: translate(65vmin, -10vmin) rotateY(-90deg);
}

section#goals {
  width: 110vmin;
  transform: translate(0,-65vmin) rotateX(-90deg);
}


/* ------------------------------------------------------------------- INSPECTOR */

.inspector {
  z-index: 100;
  transform: translate3d(108vmin,0,50vmin) rotateY(0deg);
  min-width: 15em;
  padding: 0.5em;
  border:  1px solid #ddd;
  position: absolute;
}

.mark-path {
  list-style-type: none;
  padding: 0;
  margin: 0;
}

/* ------------------------------------------------------------------- MAP */

#map img.screenshot {
  max-width: 100%;
  max-height: 100%;
  display: block; /* fix extra line space in wrapper */

  transition: opacity 0.7s;
}

.flip #map img.screenshot {
  opacity: 0.5;
}

#map div.mark {
  position: absolute;
  width: 20px;
  height: 20px;
  margin: -12px 0 0 -12px;
  border-radius: 100px;
  border: 2px solid black;
  background-color: rgba(255,255,255,0.7);
  opacity: 0.7;
  /* this does not work if opacity is set on parent ! */
  transform: translate3d(0,0,1px);
  cursor: pointer;
}

#map .mark:hover {
  border-width: 3px;
  margin: -13px 0 0 -13px;
}

#closebutton {
  position: absolute;
  opacity: 0;
  top: 0;
  right: 0;
  width: 20px;
  height: 20px;
  visibility: hidden;
  background-color: rgba(0,0,0,0.1);
  border-left: 1px solid rgba(0,0,0,0.2);
  border-bottom: 1px solid rgba(0,0,0,0.2);
  z-index: 10;
  transition: opacity 0.5s, visibility 0s 0.5s; /* durations for flipped state */
  cursor: pointer;
}

#closebutton::before {
  font-weight: bold;
  font-size: 12px;
  padding: 5px;
  vertical-align: -1px;
  content: "×";
}

.flip #closebutton {
  visibility: visible;
  opacity: 1;
  transition: opacity 1s 0.7s; /* durations for non-flipped state */
}

#map #closebutton {
  top: auto;
  right: auto;
  bottom: 50%;
  margin-bottom: -10px;
  left: 0px;
  width: 25px;
  height: 20px;
  padding: 3px 0;
  border: none;
  background-color: transparent;
  transform-origin: 100% 0;
  transform: rotateY(-90deg) translate(62px);
  border: 1px solid rgba(0,0,0,0.2);
  color: rgba(0,0,0,0.4);
}

#map #closebutton::before {
  width: auto;
  content: "◀";
}

#closebutton:hover,
#map #closebutton:hover {
  background-color: rgba(0,0,0,0.1);
  color: rgba(0,0,0,0.6);
}


#map #marks {
  position: absolute;
  top: 0;
  left: 0;
    max-width: 100%;
  max-height: 100%;

}

#map #marks .mark {
  stroke-opacity: 0.5;
}

#map #marks .mark:hover {
  fill-opacity: 0.4;
  stroke-opacity: 0.6;
  stroke-width: 5;
}

/* ------------------------------------------------------------------- CODE */

#code .highlight {
  background-color: #99ff99;
  cursor: pointer;
}

.flip #code {
  visibility: visible;
}

/* ------------------------------------------------------------------- GRAPH */

section#graph svg {
  position: absolute;
  top: 0;
  left: 0;
  overflow: visible;
}

svg#dfg {
  width: 100%;
  height: 100%;
}

/* ------------------------------------------------------------------- SOCIAL */

#github {
  display: none;
  position: absolute;
  bottom: 0;
  left: 620px;
  width: 350px;
  background-color: #ffffff;
  border: 1px solid #e0e0e0;
  font-family: sans-serif;
}

#github img {
  float: left;
  margin: 3px;
}

#github .git-author {
  font-weight: bold;
}

#github a {
  text-decoration: none;
  color: inherit;
}
</style>

</head>
<body class="flip">
<main>

<section id="map">
  <img id="screenshot" class="screenshot">
  <svg id="marks" width="800" height="800" viewBox="0 0 800 800"></svg>
  <div id="closebutton"></div>
</section>

<!--
<section id="interface">
</section>
-->

<div class="inspector">
<ol class="mark-path" id="mark-path">
<li>
<select>
<option value="0">Mark [0] (SVG path)</option>
<option value="1">Mark [1] (SVG path)</option>
</select>
</li> 
<li>
<select>
<option value="d">Attribute "d" (Path geometry)</option>
</select>
</li>
<li>
<select>
<option value="0">Operation [0] (Line to)</option>
</select>
</li>
<li>
<select>
<option value="x">X Coordinate (123)</option>
<option value="y">Y Coordinate (456)</option>
<option value="op">Opcode ("l")</option>
</select>
</li>
</ol>
<a href="tree.html?input=capture/test-projection-naive/transformations/1.json" target="_blank">Viewer</a> <a href="capture/test-projection-naive/transformations/1.json" target="_blank">Data</a>
</div>

<section id="graph">
  <svg id="dfg" width="1000" height="1000" viewBox="0 0 1000 1000" preserveAspectRatio="xMidYMid meet">
    <xcircle cx="500" cy="500" r="498" fill="transparent" stroke="#000000"/>
  </svg>
</section>

<section id="data">
  <h2>Data</h2>
</section>

<section id="parameters" class="bottom">
  <h2>Parameters</h2>
</section>

<section id="interaction" class="empty">
  <h2>Interaction</h2>
</section>

<section id="code" class="empty">
  <h2>Code</h2>
</section>

<section id="author"  class="bottom empty">
  <h2>AUTHORSHIP</h2>
  <div id="github">
    <img src="lib/github_avatar.jpg">
    <div><span class="git-author">floledermann</span> <a target="_blank" href="https://github.com/floledermann/example_simple_projection/commit/a3b85bc6c2883aa93514bd90cd112e9e72a0aa0c">2017-02-19</a></div>
    <div class="git-commit">Naive implementation of web mercator projection according to Wikipedia</div>
  </div>
</section>
<!--
<section id="ecosystem" class="bottom empty">
  <h2>Cartographic Ecosystem</h2>
</section>
-->
<section id="infrastructure" class="empty">
  <h2>Infrastructure</h2>
</section>

<!--
<section id="perception" class="right empty">
  <h2>Perception</h2>
</section>

<section id="goals" class="empty">
  <h2>Goals</h2>
</section>
-->

</main>

<script src="lib/d3.v4.js"></script>
<script src="lib/d3-selection-multi.v1.min.js"></script>
<script src="tree.js"></script>

<script>
const DEFAULT_PROJECT = "test-projection-naive",
PROJECT = (window.location.search && window.location.search.substring(1)) || DEFAULT_PROJECT,
CAPTURE_BASE = "capture/" + PROJECT
NODE_HEIGHT = 45,
NODE_WIDTH = 70,
FUNCTION_MARGIN = 4,
TREE_MARGIN = 150,
GRAPH_X_POS = 800
;

var scale = 0.6;

d3.select('body').on('mousewheel', function() {
  // one 'click' of mouse wheel will give a deltaY of 100
  scale *= (d3.event.deltaY > 0) ? 1/1.1 : 1.1; //  -d3.event.deltaY / 2000;
  console.log("Scale: " + scale);
  this.style.transform = 'scale(' + scale + ')'; // translate(500px,200px)';
});

d3.select('#screenshot').attr('src', CAPTURE_BASE + '/screenshots/' + 'small_cropped.png');

let body = d3.select(document.body),
map = d3.select('#map'),
svg = d3.select("#dfg"),
width = +svg.attr("width"),
height = +svg.attr("height"),
g = svg.append("g").attr("transform", "translate(" + GRAPH_X_POS + ",0)");
;

function clear() {
  svg.selectAll('.argLink').remove();
  svg.selectAll('.argLabel').remove();
  //d3.select('#code').html('');
  document.getElementById('github').style.display = 'none';
}

// mapping from mark types to SVG element types
const mark_elements = {
  'point': 'circle',
  'rect':'rect',
  'circle': 'circle',
  'path': 'path',
  'polyline': 'polyline',
  'polygon': 'polygon'
}

const MARK_MARGIN = 5;



d3.json(CAPTURE_BASE + '/transformations.json', (error, data) => {

  function facetGeom(facet) {
    var geom = facet.geometry;
    if (!geom) return null;
    
    let el = document.createElementNS("http://www.w3.org/2000/svg", mark_elements[geom.type]);
    let sel = d3.select(el);
    
    sel.datum(facet)
       .attr('class','mark')
    ;
    switch (geom.type) {
      case 'rect':
        sel.attrs({
          x: geom.x - MARK_MARGIN,
          y: geom.y - MARK_MARGIN,
          width: geom.width + 2 * MARK_MARGIN,
          height: geom.height + 2 * MARK_MARGIN,
          // corner radius
          rx: MARK_MARGIN,
          ry: MARK_MARGIN
        });
        break;
      case 'point':
      case 'circle':
        sel.attrs({
          cx: geom.x,
          cy: geom.y,
          r: geom.r || MARK_MARGIN
        });
        break;
      default:
        sel.attrs(facet.geometry);
    }
    sel.attrs({
      'fill':'#ffffff',
      'fill-opacity': 0.2,
      'stroke':'#000000',
      'stroke-width': 4,
      'cursor': 'pointer'
    });
    return sel;
  } 
  
  function addFacetsGeom(facets) {
    facets.forEach(facet => {
    
      let geom = facetGeom(facet);
      if (geom) {
        marksWrapper.node().appendChild(geom.node());
      }
      
      if (facet.facets) {
        addFacetsGeom(facet.facets);
      }
    })
  }

  let marksWrapper = map.select('#marks');
  
  addFacetsGeom(data.marks);
  
  marksWrapper.selectAll('.mark')
  .on('click', function(mark){

    var flipAnim = !body.classed('flip');

    body.classed('flip', true);

    g.selectAll('.tree').remove();
    clear();
    
    // search first facet that has a graph attached
    function searchGraph(facet) {
      if (facet.graph) return facet;
      
      for (child of facet.facets) {
        let graph = searchGraph(child);
        if (graph) return graph;
      }
      
      return null;
      
    }
    
    let facet = searchGraph(mark);
    
    if (facet && facet.graph) {
      d3.json(CAPTURE_BASE + '/' + facet.graph, (error, data) => {
      
        let graph = data[facet.graphOffset];
      
        var markEl = this;
        
        let tree = null;

        g.selectAll('.tree')
        .data([graph])
        .enter()
        .append('g')
        .attr('class', 'tree')
        .each(function(d,i) {

          var g = d3.select(this);

          var treeOptions = {
            nodeHeight: NODE_HEIGHT,
            nodeWidth: NODE_WIDTH,
            functionMargin: FUNCTION_MARGIN,
            nodeClick: showCode,
            delay: 1000,
            delayPerLevel: 50,
            delayFunctions: 0,
            //drawOutlines: false
          };

          if (!flipAnim) {
            Object.assign(treeOptions, {
              delay: 0,
              delayPerLevel: 0,
              delayFunctions: 0
            })
          }

          var root = drawTree(g, d, treeOptions);

          g.attr("transform","translate(0," + (500 - root.y) + ")");

          tree = root;

        });

        function showArgs() {

          var bounds = markEl.getBoundingClientRect();
          var center = [bounds.left + bounds.width / 2, bounds.top + bounds.height / 2];
          
          let svgPoint = svg.node().createSVGPoint();
          svgPoint.x = center[0];
          svgPoint.y = center[1];
          
          let xfPoint = svgPoint.matrixTransform(svg.node().getScreenCTM().inverse());
          
          //xfPoint.x = 1000;

          var links = svg.selectAll('.argLink')
          .data([tree]);

          links.enter()
          .append('path')
          .attr('class','argLink')
          .attrs({
            'fill': 'none',
            'stroke': '#555',
            'stroke-opacity': 0.4,
            'stroke-width': 1.5,
            'pointer-events': 'none'
          })
          .merge(links)
          .attr('d', (root, i) => {

            var cpDistance = (xfPoint.x - root.x - GRAPH_X_POS) / 1.5;

            return "M" + xfPoint.x + "," + xfPoint.y
            + "C" + (xfPoint.x - cpDistance) + "," + xfPoint.y
            + " " + (root.x + cpDistance + GRAPH_X_POS) + "," + (500-root.y)
            + " " + (root.x + GRAPH_X_POS) + "," + (500-root.y);
          });

        }

        if (flipAnim) {
          window.setTimeout(showArgs, 800);
        }
        else {
          showArgs();
        }
        
      });
    }
  });

  d3.select('#closebutton')
  .on('click', () => {
    body.classed('flip', false);
    g.selectAll('*').remove();
    clear();
  })
  ;

  // DEBUG trigger click on load
  //map.select('.mark').dispatch('click');
});

const CONTEXT_LINES = 5;

// TODO: smart, parser-based selection of code to show, showing function headers etc.
function showCode(node) {
  document.getElementById('github').style.display = 'none';
  if (node.data.file) {
    d3.text(CAPTURE_BASE + '/' + node.data.file, (error, data) => {

      if (error){
        console.error(error);
        return;
      }

      var lines = data.split('\n');

      var loc = node.data.loc;
      if (loc.split) loc = loc.split(':');

      // start at closing tag to avoid shifting string contents
      var l = lines[loc[2]-1];
      lines[loc[2]-1] = l.slice(0, loc[3]-1) + '</span>' + l.slice(loc[3]-1);
      l = lines[loc[0]-1];
      lines[loc[0]-1] = l.slice(0, loc[1]-1) + '<span class="highlight">' + l.slice(loc[1]-1);

      var fromLine = Math.max(loc[0]-1 - CONTEXT_LINES, 0);
      var toLine = Math.min(loc[2] + CONTEXT_LINES, lines.length);

      lines = lines.slice(fromLine, toLine);

      d3.select('#code').html(lines.join('\n'));

      d3.select('#code .highlight').on('click', function() {
        document.getElementById('github').style.display = 'block';
      });
    });
  }
  else {
    console.error("No code location given for node: ", node.data);
    //console.error(node.data);
  }
}

</script>




</body>
