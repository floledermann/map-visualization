<!DOCTYPE html>
<meta charset="utf-8">
<style>

html, body {
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
  overflow: hidden;
}

.snippet {
    font-family: monospace;
    white-space: pre;
}

svg path.function.level-1 {
    fill-opacity: 0.03;
}

svg path.function:hover {
    fill-opacity: 0.2;
    stroke-dasharray: none;
}

svg path.function.level-1:hover {
    fill-opacity: 0.1;
}

svg {
  width: 100%;
  height: 100%;
}

</style>

<svg width="100%" height="100%" xviewBox="0 0 1000 1000">
</svg>

<script src="lib/d3.v4.js"></script>
<script src="lib/d3-selection-multi.v1.min.js"></script>
<script src="tree.js"></script>
<script>

var svg = d3.select("svg"),
  wrapper = svg.append("g"),
    width = 1000, //+svg.attr("width"),
    height = 1000, //+svg.attr("height"),
    g = wrapper.append("g").attr("transform", "translate(1600,0) scale(0.7)");

function getQueryData() {
  var query = location.search.substr(1);
  var result = {};
  query.split("&").forEach(function(part) {
    var item = part.split("=");
    result[item[0]] = decodeURIComponent(item[1]);
  });
  return result;
}

var QUERY = getQueryData();

var INPUT = QUERY.input || "d3_mercator.json",
    NODE_HEIGHT = 45, //145,
    NODE_WIDTH = NODE_HEIGHT * 1.5,
    TREE_MARGIN = 100,
    FUNCTION_MARGIN = 4;

svg.call(d3.zoom().on("zoom", function() {
  wrapper.attr("transform", d3.event.transform);
}))
/*
var stratify = d3.stratify()
    .parentId(function(d) { return d.id.substring(0, d.id.lastIndexOf(".")); });
*/
d3.json(INPUT, function(error, treeData) {
  if (error) throw error;

  var yOffset = TREE_MARGIN;

  var maxWidth = 0;
  var lastRoot = null;

  // support JSON produced by map-capture
  // TODO: implement simple browsing interface?
  if (treeData.marks) {
    var index = parseInt(QUERY.index) || 0;
    mark = treeData.marks[index];
    treeData = [mark.channels.geometry[0].x, mark.channels.geometry[0].y];
  }

  g.selectAll(".tree")
    .data(treeData)
    .enter()
    .append("g")
    .attr("class", "tree")
    .each(function(d,i) {

        var g = d3.select(this);

        var root = drawTree(g, d, {
          nodeHeight: NODE_HEIGHT,
          nodeWidth: NODE_WIDTH,
          functionMargin: FUNCTION_MARGIN,
          //drawOutlines: false
        });

        if (lastRoot) {
          yOffset += TREE_MARGIN + compactDistance(lastRoot, root);
        }
        else {
          yOffset -= root.minY; // first tree - minY will be negative!
        }
        g.attr("transform","translate(0," + yOffset + ")");

        lastRoot = root;

    })
  ;
  if (lastRoot) {
    yOffset += TREE_MARGIN + lastRoot.maxY;
  }
  g.selectAll(".node").on("click", function(d){
    console.log(d.data);
  })
});

</script>
