<!DOCTYPE html>
<meta charset="utf-8">
<html>
<head>

<style>

html {
    overflow-y: scroll;
}

html, body {
  margin: 0;
  padding: 0;
  height: 100%;
}

body {
  background-color: #999999;
  transition: background-color 1s;
}

body.flip {
  background-color: #ffffff;
}

main {
  position: relative;
  height: 100%;
  perspective: 1600px;
  perspective-origin: 80% 30%;
}

#map {
  position: absolute;
  right: 0px;
  background-color: transparent;
  border: 1px solid #bbbbbb;

  margin: 5% 5% 0 0;

  max-width: 90%;
  max-height: 90%;

  backface-visibility: visible;
  transform-origin: 70% 50%;
  transform-style: preserve-3d;

  transition: transform 0.7s, opacity 0.7s;

}

#map img.screenshot {
  max-width: 100%;
  max-height: 100%;
  display: block; /* fix extra line space in wrapper */

  transition: opacity 0.7s;
}

.flip #map img.screenshot {
  xopacity: 0.5;
}

#map .mark {
  position: absolute;
  /*top: 26.8%;
  left: 20.7%;*/
  width: 20px;
  height: 20px;
  margin: -12px 0 0 -12px;
  border-radius: 100px;
  border: 2px solid black;
  background-color: rgba(255,255,255,0.7);
  opacity: 0.7;
  /* this does not work if opacity is set on parent ! */
  transform: translate3d(0,0,1px);
  cursor: pointer;
}

#map .mark:hover {
  border-width: 3px;
  margin: -13px 0 0 -13px;
}

.flip #map {
  transform: translate(230px) rotateY(72deg);
  xopacity: 0.5;
}

#closebutton {
  position: absolute;
  opacity: 0;
  top: 0;
  right: 0;
  width: 20px;
  height: 20px;
  visibility: hidden;
  background-color: rgba(0,0,0,0.1);
  border-left: 1px solid rgba(0,0,0,0.2);
  border-bottom: 1px solid rgba(0,0,0,0.2);
  z-index: 10;
  transition: opacity 0.5s, visibility 0s 0.5s; /* durations for flipped state */
  cursor: pointer;
}

#closebutton::before {
  font-weight: bold;
  font-size: 12px;
  padding: 5px;
  vertical-align: -1px;
  content: "×";
}

.flip #closebutton {
  visibility: visible;
  opacity: 1;
  transition: opacity 1s 0.7s; /* durations for non-flipped state */
}

#map #closebutton {
  top: auto;
  right: auto;
  bottom: -1px;
  left: -22px;
  width: 25px;
  height: 20px;
  padding-top: 2px;
  border: none;
  background-color: transparent;
  transform-origin: 100% 0;
  transform: rotateY(-72deg);
}

#map #closebutton::before {
  width: auto;
  content: "◀";
}

#code {
  position: absolute;
  bottom: 0;
  visibility: hidden;
  white-space: pre;
  font-family: monospace;
  padding: 5px;
  width: 600px;
  overflow: auto;
  background-color: #f6f6f6;
  border: 1px solid #e0e0e0;
}

#code .highlight {
  background-color: #99ff99;
}

.flip #code {
  visibility: visible;
}

</style>

</head>
<body>
<main>


<div id="map">
<img id="screenshot" class="screenshot">
<div id="closebutton"></div>
</div>

<svg id="graph" width="800" height="800">
</svg>

<div id="code"></div>

</main>

<script src="//d3js.org/d3.v4.js"></script>
<script src="//d3js.org/d3-selection-multi.v1.min.js"></script>
<script src="tree.js"></script>

<script>
const DEFAULT_PROJECT = "test-projection-naive",
  PROJECT = (window.location.search && window.location.search.substring(1)) || DEFAULT_PROJECT,
  CAPTURE_BASE = "capture/" + PROJECT
  NODE_HEIGHT = 45,
  NODE_WIDTH = 70,
  FUNCTION_MARGIN = 4,
  TREE_MARGIN = 150
;

d3.select('#screenshot').attr('src', CAPTURE_BASE + '/screenshots/' + PROJECT + '_small_0_0.png');

let body = d3.select(document.body),
  map = d3.select('#map'),
  svg = d3.select("svg"),
  width = +svg.attr("width"),
  height = +svg.attr("height"),
  g = svg.append("g").attr("transform", "translate(750,0)");
;

d3.json(CAPTURE_BASE + '/transformations.json', (error, data) => {

  let marks = map.selectAll('.mark').data(data);

  marks.enter()
    .append('div')
    .attr('class','mark')
    .style('top', d => d.location.y + 'px')
    .style('left', d => d.location.x + 'px')
    .on('click', (d) => {

      body.classed('flip', true);

      g.selectAll('.tree').remove();

      var yOffset = TREE_MARGIN / 2;
      var lastRoot = null;

      g.selectAll('.tree')
        .data(d.args)
        .enter()
        .append('g')
        .attr('class', 'tree')
        .each(function(d,i) {

            var g = d3.select(this);

            var root = drawTree(g, d, {
              nodeHeight: NODE_HEIGHT,
              nodeWidth: NODE_WIDTH,
              functionMargin: FUNCTION_MARGIN,
              nodeClick: showCode,
              delay: 1000,
              delayPerLevel: 50,
              delayFunctions: 700
            });

            if (lastRoot) {
              yOffset += TREE_MARGIN + compactDistance(lastRoot, root);
            }
            else {
              yOffset -= root.minY; // first tree - minY will be negative!
            }
            g.attr("transform","translate(0," + yOffset + ")");

            lastRoot = root;

        });

        if (lastRoot) {
          yOffset += TREE_MARGIN / 2 + lastRoot.maxY;
        }
        //svg.attr('height', yOffset);
      ;
    })
  ;

  d3.select('#closebutton')
    .on('click', () => {
      body.classed('flip', false);
      g.selectAll('*').remove();
    })
  ;

  // DEBUG trigger click on load
  map.select('.mark').dispatch('click');
});

const CONTEXT_LINES = 5;

// TODO: smart, parser-based selection of code to show, showing function headers etc.
function showCode(node) {
  if (node.data.file) {
    d3.text(CAPTURE_BASE + '/' + node.data.file, (error, data) => {

      if (error){
        console.error(error);
        return;
      }

      var lines = data.split('\n');

      var loc = node.data.loc;
      if (loc.split) loc = loc.split(':');

      // start at closing tag to avoid shifting string contents
      var l = lines[loc[2]-1];
      lines[loc[2]-1] = l.slice(0, loc[3]-1) + '</span>' + l.slice(loc[3]-1);
      l = lines[loc[0]-1];
      lines[loc[0]-1] = l.slice(0, loc[1]-1) + '<span class="highlight">' + l.slice(loc[1]-1);

      var fromLine = Math.max(loc[0]-1 - CONTEXT_LINES, 0);
      var toLine = Math.min(loc[2] + CONTEXT_LINES, lines.length);

      lines = lines.slice(fromLine, toLine);

      d3.select('#code').html(lines.join('\n'));
    });
  }
  else {
    console.error("No code location given for node: ", node.data);
    //console.error(node.data);
  }
}

</script>




</body>
